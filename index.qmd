---
title: "Vietnam serum bank"
number-sections: true
format:
  html:
    toc: true
    toc-depth: 4
editor: source
editor_options: 
  chunk_output_type: console
#bibliography: references.bib
#csl: the-american-naturalist.csl
---

```{r include = FALSE, eval = FALSE}
# The code that adds the .nojekyll file to the GitHub repository:
file <- ".nojekyll"
file.create(file)
gert::git_add(file)
gert::git_commit("Adding the .nojekyll file")
gert::git_push()
rm(file)
```

```{r include = FALSE, eval = FALSE}
run_all <- function() {
  knitr::purl("index.qmd", "tmp.R", documentation = FALSE)
  source("tmp.R")
  file.remove("tmp.R")  
}

rerun_all <- function() {
  rm(list  = grep("run_all", ls(envir = .GlobalEnv), value = TRUE, invert = TRUE),
     envir = .GlobalEnv)
  run_all()
}
```

```{r include = FALSE}
par2 <- function(...) par(..., mgp = c(1.5, .5, 0), bty = "n")

knitr::knit_hooks$set(
  margin1 = function(before, options, envir) {
    if (before) par2(plt = c(.105, .97, .15, .95)) else NULL
  })

eps <- .8
knitr::opts_chunk$set(margin1    = TRUE,
                      fig.retina = 2,
                      fig.align  = "center",
                      fig.height = eps * 5, # default is 5
                      fig.width  = eps * 7) # default is 7 and maximum possible is 8.3
```


## Contants

The OneDrive root:

```{r}
OneDrive <- "~/Library/CloudStorage/OneDrive-OxfordUniversityClinicalResearchUnit"
```

Path to raw data:

```{r}
path2data <- paste0(OneDrive, "/SPECIAL/MODELLING/Hoang Nhung/20FL/20FL_samples/",
                    "20FL_samples_v2/standardized_20FL_metadata/")
```

```{r include = FALSE}
path2cache <- paste0(stringr::str_replace(getwd(), Sys.getenv("HOME"), OneDrive),
                     "/cache/")
if (! dir.exists(path2cache)) dir.create(path2cache)
make_path <- function(x) paste0(path2cache, x)
file_exists <- function(x) file.exists(make_path(x))
readRDScache <- function(x) readRDS(make_path(x))
saveRDScache <- function(object, file) saveRDS(object, make_path(file))
```

```{r}
bissexts <- seq(1952, 2030, 4)
not31 <- c(2, 4, 6, 9, 11)
```


## Packages

Required packages:

```{r}
required <- c("readxl", "stringr", "purrr", "dplyr", "lubridate", "stringi")
```

Installing those that are not installed yet:

```{r}
to_install <- required[! required %in% installed.packages()[,"Package"]]
if (length(to_install)) install.packages(to_install)
```

Loading the packages for interactive use:

```{r warning = FALSE, message = FALSE}
invisible(sapply(required, library, character.only = TRUE))
```

## Functions

A tuning of the `grep()` function:

```{r}
grep2 <- function(...) grep(..., ignore.case = TRUE, value = TRUE)
```


## Reading the data

```{r}
recode_sex <- function(x) {
  tmp <- na.exclude(unique(x$Gender))
  females <- c("F", "f", grep2("^.a", grep2("^n", tmp), invert = TRUE))
  males <- setdiff(tmp, females)
  mutate(x, across(Gender, ~ case_match(.x, females ~ "female", males ~ "male",
                                        .default = .x)))
}
```

Takes 3.5":

```{r eval = FALSE}
dataset <- path2data |> 
  list.files(".xlsx$", full.names = TRUE, recursive = TRUE) |> 
  grep("~", x = _, value = TRUE, invert = TRUE) |> 
  map(read_excel) |> 
  bind_rows() |> 
  select(-c(Note, Sample_type, patient_ID, Initial_name, starts_with("Address"),
            Exact_age_calculated, Check_age_in_correct_group, Age_ontube)) |> 
  filter_out(is.na(Sample_ID)) |> 
  mutate(across(Collection_year, ~ replace_values(.x, "202" ~ "2022", "21" ~ "2021")),
         across(Birth_year, ~ replace_values(.x, "86" ~ "1986")),
         across(ends_with(c("day", "month", "year")), as.integer),
         across(ends_with("month"), ~ if_else(.x < 1 | 12 < .x, NA_integer_, .x)),
         across(ends_with("day"), ~ if_else(.x > 31, NA_integer_, .x)),
         across(Birth_day, ~ if_else(.x > 30 & Birth_month %in% not31,
                                     NA_integer_, .x)),
         across(Collection_day, ~ if_else(.x > 30 & Collection_month %in% not31,
                                          NA_integer_, .x)),
         across(Birth_day, ~ if_else(.x > 28 & Birth_month == 2 &
                                       ! Birth_year %in% bissexts,
                                     NA_integer_, .)),
         across(Collection_day, ~ if_else(.x > 28 & Collection_month == 2 &
                                            ! Collection_year %in% bissexts,
                                          NA_integer_, .)),
         across(Gender, ~ .x |>
                  stri_trans_general("any-ascii") |>
                  tolower() |> 
                  replace_values(c("f", "nu", "nuu", "nux", "nnu") ~ "female",
                                 c("m", "nam", ",m")               ~   "male")),
         across(Province, ~ .x |>
                  stri_trans_general("any-ascii") |> 
                  replace_values("Can Tho_former Soc Trang"   ~ "Can Tho",
                                 "Daklak"                     ~ "Dak Lak",
                                 "Dong Nai_former Binh Phuoc" ~ "Dong Nai",
                                 "DT"                         ~ "Dong Thap",
                                 "Gia Lai_fomer Binh Dinh"    ~ "Gia Lai",
                                 "Gia Lai_former Binh Dinh"   ~ "Gia Lai",
                                 "HCM"                        ~ "HCMC",
                                 "HUE"                        ~ "Hue",
                                 "QN"                         ~ "Quang Ngai",
                                 "Nu"                         ~ "Quang Ngai")))
```

```{r}

```



**Note:** in 2025,

* Soc Trang became Can Tho
* Binh Phuoc became Dong Nai
* Binh Dinh became Gia Lai


```{r include = FALSE}
if (file_exists("dataset.rds")) {
  dataset <- readRDScache("dataset.rds")
} else {
  dataset <- path2data |> 
    list.files(".xlsx$", full.names = TRUE, recursive = TRUE) |> 
    grep("~", x = _, value = TRUE, invert = TRUE) |> 
    map(read_excel) |> 
    bind_rows() |> 
    select(-c(Note, Sample_type, patient_ID, Initial_name, starts_with("Address"),
              Exact_age_calculated, Check_age_in_correct_group, Age_ontube)) |> 
    filter_out(is.na(Sample_ID)) |> 
    mutate(across(Collection_year, ~ replace_values(.x, "202" ~ "2022", "21" ~ "2021")),
           across(Birth_year, ~ replace_values(.x, "86" ~ "1986")),
           across(ends_with(c("day", "month", "year")), as.integer),
           across(ends_with("month"), ~ if_else(.x < 1 | 12 < .x, NA_integer_, .x)),
           across(ends_with("day"), ~ if_else(.x > 31, NA_integer_, .x)),
           across(Birth_day, ~ if_else(.x > 30 & Birth_month %in% not31,
                                       NA_integer_, .x)),
           across(Collection_day, ~ if_else(.x > 30 & Collection_month %in% not31,
                                            NA_integer_, .x)),
           across(Birth_day, ~ if_else(.x > 28 & Birth_month == 2 &
                                         ! Birth_year %in% bissexts,
                                       NA_integer_, .)),
           across(Collection_day, ~ if_else(.x > 28 & Collection_month == 2 &
                                              ! Collection_year %in% bissexts,
                                            NA_integer_, .)),
           across(Gender, ~ .x |>
                    stri_trans_general("any-ascii") |>
                    tolower() |> 
                    replace_values(c("f", "nu", "nuu", "nux", "nnu") ~ "female",
                                   c("m", "nam", ",m") ~ "male")))
  saveRDScache(dataset, "dataset.rds")
}
```

```{r}
map_int(dataset, ~ sum(is.na(.x)))
```

0: Out-patient, not admitted to any ward.
1: Respiratory/chest ward
2: Gastroenterology ward
3: General surgical ward
4: Trauma/Orthopedics
5: Intensive care unit
6: Other ward (not listed above)
7: Unknown

## Looking at the data

```{r}
dataset |> 
  filter(is.na(Collection_year)) |> 
  print(n = Inf)
```

